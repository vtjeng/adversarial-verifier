using MAT
using JuMP
using Gurobi
include("nn_ops.jl")
include("nn_examples.jl")
include("util.jl")

"""
Warning for adding constraints: zero or small (< 1e-13) coefficients, ignored
Optimize a model with 7004 rows, 4710 columns and 57612 nonzeros
Model has 196 quadratic objective terms
Variable types: 2882 continuous, 1828 integer (1828 binary)
Coefficient statistics:
  Matrix range     [2e-07, 3e+01]
  Objective range  [0e+00, 0e+00]
  QObjective range [2e+00, 2e+00]
  Bounds range     [1e+00, 1e+00]
  RHS range        [1e-04, 3e+01]
Presolve removed 2202 rows and 1101 columns
Presolve time: 0.56s
Presolved: 4802 rows, 3609 columns, 56151 nonzeros
Presolved model has 196 quadratic objective terms

Loaded MIP start with objective 0.503175

Variable types: 2229 continuous, 1380 integer (1380 binary)
Presolve removed 596 rows and 596 columns
Presolved: 4206 rows, 3013 columns, 54363 nonzeros
Presolved model has 196 quadratic objective terms


Root simplex log...

Iteration    Objective       Primal Inf.    Dual Inf.      Time
   31441    6.8360059e-02   1.777114e+02   0.000000e+00      5s
   49846    0.0000000e+00   0.000000e+00   0.000000e+00      9s
   49846    0.0000000e+00   0.000000e+00   0.000000e+00      9s

Root relaxation: objective 0.000000e+00, 49846 iterations, 8.32 seconds

    Nodes    |    Current Node    |     Objective Bounds      |     Work
 Expl Unexpl |  Obj  Depth IntInf | Incumbent    BestBd   Gap | It/Node Time

     0     0    0.00000    0  730    0.50317    0.00000   100%     -    9s
     0     0    0.00000    0  660    0.50317    0.00000   100%     -   31s
     0     0    0.00000    0  655    0.50317    0.00000   100%     -   31s
     0     0    0.00000    0  637    0.50317    0.00000   100%     -   54s
     0     0    0.00000    0  636    0.50317    0.00000   100%     -   55s
     0     0    0.00000    0  725    0.50317    0.00000   100%     -   85s
     0     0    0.00000    0  643    0.50317    0.00000   100%     -  201s
     0     0    0.00000    0  682    0.50317    0.00000   100%     -  226s
     0     0    0.00000    0  602    0.50317    0.00000   100%     -  230s
     0     0    0.00000    0  693    0.50317    0.00000   100%     -  748s
     0     0    0.00000    0  650    0.50317    0.00000   100%     -  770s
     0     0    0.00000    0  650    0.50317    0.00000   100%     -  770s
     0     2    0.00000    0  650    0.50317    0.00000   100%     -  776s
     4     4    0.46940    2  621    0.50317    0.00000   100%  46.0  806s
     7     6    0.46940    3  621    0.50317    0.00000   100%  9770  881s
    12     9    0.47804    4  640    0.50317    0.00000   100% 45730  897s
    18    13    0.00000    6  615    0.50317    0.00000   100% 30512  900s
    30    22    0.47804    7  650    0.50317    0.00000   100% 18324  928s
    32    23    0.31657    6  750    0.50317    0.00000   100% 17179  935s
    33    24    0.46940    9  739    0.50317    0.00000   100% 16658 1194s
    34    25    0.47804    9  745    0.50317    0.00000   100% 16168 1429s
    35    25    0.12227    9  721    0.50317    0.00000   100% 15706 1673s
    36    26    0.14923    8  694    0.50317    0.00000   100% 15270 1690s
    37    27    0.46940    9  712    0.50317    0.00000   100% 14857 1874s
    38    27    0.39192    4  676    0.50317    0.00000   100% 14466 1878s
    39    28    0.47804    9  705    0.50317    0.00000   100% 14095 2159s
    40    29    0.46940    8  699    0.50317    0.00000   100% 13743 2410s
    41    29    0.46940    9  692    0.50317    0.00000   100% 13408 2578s
    42    30    0.46940    9  679    0.50317    0.00000   100% 13089 2850s
    43    31    0.39192    4  682    0.50317    0.00000   100% 12784 3042s
    44    31    0.46940    9  673    0.50317    0.00000   100% 12494 3255s
    45    32    0.14923    8  684    0.50317    0.00000   100% 12216 3312s
    46    33    0.46940    9  692    0.50317    0.00000   100% 11950 3554s
    47    33    0.47804    9  578    0.50317    0.00000   100% 11696 4058s
    48    34    0.14923    8  664    0.50317    0.00000   100% 11453 4256s
    49    35    0.00000    9  652    0.50317    0.00000   100% 11219 4500s
    50    35    0.47804    7  650    0.50317    0.00000   100% 10994 4630s
    51    36    0.47804    9  719    0.50317    0.00000   100% 10779 4922s
    55    39    0.12227    9  703    0.50317    0.00000   100%  9995 4930s
    57    40    0.46940    9  650    0.50317    0.00000   100% 233436 5099s
    59    41    0.47804    9  750    0.50317    0.00000   100% 225523 5195s
    60    42    0.46940    8  666    0.50317    0.00000   100% 221764 5339s
    61    43    0.46940    9  635    0.50317    0.00000   100% 218129 5678s
    62    43    0.46940    9  667    0.50317    0.00000   100% 214611 5901s
    63    44    0.39192    4  662    0.50317    0.00000   100% 211204 6209s
    64    45    0.46940    9  666    0.50317    0.00000   100% 207904 6571s
    65    45    0.14923    8  671    0.50317    0.00000   100% 204706 6932s
    66    46    0.46940    9  655    0.50317    0.00000   100% 201604 7188s
    67    47    0.47804    9  686    0.50317    0.00000   100% 198595 7537s
    68    47    0.14923    8  678    0.50317    0.00000   100% 195674 7778s
    69    48    0.00000    9  681    0.50317    0.00000   100% 192839 8035s
    70    49    0.47804    7  662    0.50317    0.00000   100% 190084 8189s
    73    51    0.46940    9  640    0.50317    0.00000   100% 182272 8197s
    75    52    0.12227    9  650    0.50317    0.00000   100% 318036 8479s
    77    53    0.46940    9  697    0.50317    0.00000   100% 309775 9030s
    78    54    0.39192    4  676    0.50317    0.00000   100% 305803 9321s
    79    55    0.47804    9  643    0.50317    0.00000   100% 301932 9387s
    80    55    0.46940    8  670    0.50317    0.00000   100% 298158 9759s
    81    56    0.46940    9  621    0.50317    0.00000   100% 294477 9809s
    82    57    0.46940    9  652    0.50317    0.00000   100% 290886 10234s
    83    57    0.39192    4  667    0.50317    0.00000   100% 287381 10514s
    84    58    0.46940    9  617    0.50317    0.00000   100% 283960 10660s
    85    59    0.14923    8  643    0.50317    0.00000   100% 280620 11064s
    86    59    0.46940    9  622    0.50317    0.00000   100% 277357 11370s
    87    60    0.47804    9  626    0.50317    0.00000   100% 274169 11645s
    88    61    0.14923    8  688    0.50317    0.00000   100% 271053 11876s
    89    61    0.00000    9  657    0.50317    0.00000   100% 268007 12235s
    90    62    0.47804    7  590    0.50317    0.00000   100% 265030 13250s
    91    63    0.47804    9  638    0.50317    0.00000   100% 262117 13503s
    92    63    0.31657    6  630    0.50317    0.00000   100% 259268 13580s
    93    64    0.46940    9  628    0.50317    0.00000   100% 256480 13700s
    94    65    0.47804    9  654    0.50317    0.00000   100% 253752 13833s
    97    67    0.46940    9  650    0.50317    0.00000   100% 245904 13841s
    99    69    0.47804    9  650    0.50317    0.00000   100% 420893 14335s
   101    70    0.46940    9  704    0.50317    0.00000   100% 412559 14341s
   102    71    0.46940    9  655    0.50317    0.00000   100% 408514 14420s
   103    72    0.39192    4  638    0.50317    0.00000   100% 404548 14530s
   104    72    0.46940    9  625    0.50317    0.00000   100% 400658 14842s
   105    73    0.14923    8  634    0.50317    0.00000   100% 396842 15188s
   106    74    0.46940    9  627    0.50317    0.00000   100% 393098 15317s
   107    74    0.47804    9  638    0.50317    0.00000   100% 389425 15535s
   108    75    0.14923    8  654    0.50317    0.00000   100% 385819 15554s
   109    76    0.00000    9  664    0.50317    0.00000   100% 382279 15855s
   110    76    0.47804    7  647    0.50317    0.00000   100% 378804 16033s
   111    77    0.47804    9  635    0.50317    0.00000   100% 375391 16253s
   112    78    0.31657    6  668    0.50317    0.00000   100% 372040 16676s
   115    80    0.12227    9  663    0.50317    0.00000   100% 362334 16683s
   117    82    0.46940    9  650    0.50317    0.00000   100% 428514 17244s
   119    83    0.47804    9  699    0.50317    0.00000   100% 421312 17249s
   120    84    0.46940    8  631    0.50317    0.00000   100% 417801 17371s
   121    85    0.46940    9  661    0.50317    0.00000   100% 414348 17594s
   122    85    0.46940    9  644    0.50317    0.00000   100% 410952 17872s
   123    86    0.39192    4  641    0.50317    0.00000   100% 407611 18218s
   124    87    0.46940    9  615    0.50317    0.00000   100% 404323 18533s
   125    87    0.14923    8  637    0.50317    0.00000   100% 401089 18711s
   126    88    0.46940    9  614    0.50317    0.00000   100% 397906 19002s
   127    89    0.47804    9  628    0.50317    0.00000   100% 394772 19153s
   128    89    0.14923    8  655    0.50317    0.00000   100% 391688 19306s
   129    90    0.00000    9  653    0.50317    0.00000   100% 388652 19465s
   130    91    0.47804    7  674    0.50317    0.00000   100% 385662 19513s
   131    91    0.47804    9  619    0.50317    0.00000   100% 382718 19694s
   132    92    0.31657    6  617    0.50317    0.00000   100% 379819 19862s
   135    94    0.12227    9  615    0.50317    0.00000   100% 371379 19870s
   137    97    0.46940    9  650    0.50317    0.00000   100% 430061 20532s
   139    98    0.47804    9  681    0.50317    0.00000   100% 423874 20547s
   140    99    0.46940    8  677    0.50317    0.00000   100% 420846 20798s
   141   100    0.46940    9  607    0.50317    0.00000   100% 417861 20930s
   142   100    0.46940    9  561    0.50317    0.00000   100% 414918 21638s
   143   101    0.39192    4  614    0.50317    0.00000   100% 412017 21856s
   144   102    0.46940    9  619    0.50317    0.00000   100% 409156 22205s
   145   102    0.14923    8  659    0.50317    0.00000   100% 406334 22450s
   146   103    0.46940    9  638    0.50317    0.00000   100% 403551 22678s
   147   104    0.47804    9  609    0.50317    0.00000   100% 400806 22952s
   148   104    0.14923    8  676    0.50317    0.00000   100% 398097 23215s
   149   105    0.00000    9  626    0.50317    0.00000   100% 395426 23538s
   150   106    0.47804    7  618    0.50317    0.00000   100% 392789 23877s
   152   107    0.31657    6  618    0.50317    0.00000   100% 387621 23885s
   154   110    0.47804    9  650    0.50317    0.00000   100% 454675 24725s
   156   111    0.14923    8  655    0.50317    0.00000   100% 448846 24753s
   157   112    0.46940    9  654    0.50317    0.00000   100% 445987 25028s
   158   113    0.39192    4  602    0.50317    0.00000   100% 443164 25193s
   159   113    0.47804    9  619    0.50317    0.00000   100% 440377 25404s
   160   114    0.46940    8  636    0.50317    0.00000   100% 437625 25559s
   161   115    0.46940    9  644    0.50317    0.00000   100% 434906 25796s
   162   115    0.46940    9  617    0.50317    0.00000   100% 432222 26276s
   163   116    0.39192    4  613    0.50317    0.00000   100% 429570 26497s
   164   117    0.46940    9  650    0.50317    0.00000   100% 426951 26704s
   165   117    0.14923    8  627    0.50317    0.00000   100% 424363 27238s
   166   118    0.46940    9  623    0.50317    0.00000   100% 421807 27328s
   167   119    0.47804    9  580    0.50317    0.00000   100% 419281 27673s
   168   119    0.14923    8  575    0.50317    0.00000   100% 416785 28441s
   169   120    0.00000    9  632    0.50317    0.00000   100% 414319 28779s
   170   121    0.47804    7  598    0.50317    0.00000   100% 411882 28797s
   171   121    0.47804    9  631    0.50317    0.00000   100% 409473 29080s
   172   122    0.31657    6  622    0.50317    0.00000   100% 407093 29386s
   175   124    0.12227    9  620    0.50317    0.00000   100% 400114 29393s
   177   127    0.46940    9  650    0.50317    0.00000   100% 484232 30384s
   179   128    0.47804    9  663    0.50317    0.00000   100% 478821 30389s
   180   129    0.46940    8  625    0.50317    0.00000   100% 476161 30662s
   181   130    0.46940    9  620    0.50317    0.00000   100% 473530 30929s
   182   130    0.46940    9  625    0.50317    0.00000   100% 470929 31195s
   183   131    0.39192    4  593    0.50317    0.00000   100% 468355 31506s
   184   132    0.46940    9  666    0.50317    0.00000   100% 465810 31655s
   186   133    0.46940    9  666    0.50317    0.00000   100% 460801 31664s
   188   136    0.14923    8  650    0.50317    0.00000   100% 478296 32762s
   190   137    0.47804    7  670    0.50317    0.00000   100% 473261 32768s
   191   138    0.47804    9  572    0.50317    0.00000   100% 470783 32999s
   192   139    0.31657    6  646    0.50317    0.00000   100% 468331 33582s
   193   139    0.46940    9  617    0.50317    0.00000   100% 465905 33784s
   194   140    0.47804    9  616    0.50317    0.00000   100% 463503 33831s
   195   141    0.12227    9  647    0.50317    0.00000   100% 461126 33982s
   198   143    0.39192    4  645    0.50317    0.00000   100% 454140 33990s
   200   145    0.46940    8  650    0.50317    0.00000   100% 472074 35152s
   202   146    0.46940    9  644    0.50317    0.00000   100% 467400 35156s
   203   147    0.39192    4  655    0.50317    0.00000   100% 465098 35335s
   204   148    0.46940    9  607    0.50317    0.00000   100% 462818 35421s
   205   148    0.14923    8  609    0.50317    0.00000   100% 460560 35527s
   206   149    0.46940    9  644    0.50317    0.00000   100% 458325 35579s
   207   150    0.47804    9  649    0.50317    0.00000   100% 456110 35927s
   208   150    0.14923    8  645    0.50317    0.00000   100% 453918 36295s
   209   151    0.00000    9  620    0.50317    0.00000   100% 451746 36551s
   210   152    0.47804    7  611    0.50317    0.00000   100% 449595 36989s
   211   152    0.47804    9  653    0.50317    0.00000   100% 447464 37131s
   212   153    0.31657    6  642    0.50317    0.00000   100% 445353 37480s
   213   154    0.46940    9  629    0.50317    0.00000   100% 443262 37568s
   215   155    0.12227    9  629    0.50317    0.00000   100% 439139 37575s
   216   159    0.00000  111  629    0.50317    0.00000   100% 474973 37649s
   218   159    0.00000  112  628    0.50317    0.00000   100% 472120 37696s
   222   160    0.00000  113  626    0.50317    0.00000   100% 463917 37781s
   226   160    0.00000  114  625    0.50317    0.00000   100% 459855 37865s
   230   163    0.00000  115  624    0.50317    0.00000   100% 453859 37963s
   234   165    0.00000  116  623    0.50317    0.00000   100% 450545 38048s
   238   165    0.00000  117  622    0.50317    0.00000   100% 446000 38133s
   243   169    0.00000  119  611    0.50317    0.00000   100% 438700 38222s
   248   168    0.00000  120  611    0.50317    0.00000   100% 433824 38307s
   253   171    0.00000  121  611    0.50317    0.00000   100% 427060 38393s
   258   169    0.45854  122  602    0.50317    0.00000   100% 421625 38479s
   266   172    0.00000  125  607    0.50317    0.00000   100% 411648 38564s
   272   179    0.00000  128  610    0.50317    0.00000   100% 405249 38647s
   280   179    0.00000  131  596    0.50317    0.00000   100% 396014 38732s
   290   188    0.00000  135  592    0.50317    0.00000   100% 384620 38817s
   300   193    0.00000  139  582    0.50317    0.00000   100% 373986 38906s
   309   200    0.00000  142  582    0.50317    0.00000   100% 366278 38994s
   317   198    0.00000  146  577    0.50317    0.00000   100% 360139 39092s
   322   208  postponed  147         0.50317    0.00000   100% 359638 39191s
   326   206    0.00000  148  549    0.50317    0.00000   100% 358416 39299s
   333   215    0.00000  150  543    0.50317    0.00000   100% 354821 39388s
   342   213    0.00000  154  538    0.50317    0.00000   100% 348361 39485s
   348   220    0.00000  155  536    0.50317    0.00000   100% 345999 39574s
   361   221    0.00000  157  535    0.50317    0.00000   100% 336265 39662s
   377   236    0.00000  161  537    0.50317    0.00000   100% 324604 39760s
   382   234    0.00000  162  536    0.50317    0.00000   100% 323789 39870s
   388   241    0.00000  163  536    0.50317    0.00000   100% 322313 39977s
   401   243    0.00000  168  532    0.50317    0.00000   100% 315283 40082s
   409   242    0.00000  170  530    0.50317    0.00000   100% 312469 40166s
   431   253    0.00914  176  523    0.50317    0.00000   100% 298136 40247s
   455   272    0.00000  183  520    0.50317    0.00000   100% 283853 40351s
   473   274    0.00000  186  513    0.50317    0.00000   100% 275824 40452s
   481   277    0.00000  188  512    0.50317    0.00000   100% 273964 40584s
   499   287    0.00000  196  510    0.50317    0.00000   100% 266711 40674s
   518   302    0.44033  203  509    0.50317    0.00000   100% 258837 40762s
   537   308    0.00000  212  490    0.50317    0.00000   100% 251512 40851s
   557   322    0.00000  221  483    0.50317    0.00000   100% 244247 40940s
   578   334    0.00376  230  479    0.50317    0.00000   100% 237076 41028s
   602   350    0.05002  240  475    0.50317    0.00000   100% 229260 41123s
   626   361    0.00000  251  460    0.50317    0.00000   100% 222139 41218s
   651   383    0.04489  261  466    0.50317    0.00000   100% 215217 41323s
   664   388  postponed  266         0.50317    0.00000   100% 213569 41494s
   670   390  postponed  266         0.50317    0.00000   100% 214199 41686s
   678   399  postponed  267         0.50317    0.00000   100% 215540 41883s
   686   404  postponed  268         0.50317    0.00000   100% 216850 42076s
   694   410  postponed  269         0.50317    0.00000   100% 218130 42272s
   702   412  postponed  270         0.50317    0.00000   100% 219381 42463s
   712   420  postponed  271         0.50317    0.00000   100% 219889 42667s
   742   446  postponed  273         0.50317    0.00000   100% 214332 42856s
   775   481  postponed  274         0.50317    0.00000   100% 207944 43034s
   821   521  postponed  275         0.50317    0.00000   100% 198689 43341s
   898   595  postponed  276         0.50317    0.00000   100% 185372 43664s
   978   678    0.04756  278  524    0.50317    0.00000   100% 173741 44002s
  1065   761  postponed  281         0.50317    0.00000   100% 163358 44374s
  1154   851  postponed  283         0.50317    0.00000   100% 154838 44782s
  1171   868  postponed  285         0.50317    0.00000   100% 156769 45216s
  1187   883  postponed  287         0.50317    0.00000   100% 159076 45648s
  1203   893  postponed  289         0.50317    0.00000   100% 161321 46080s
  1220   915  postponed  291         0.50317    0.00000   100% 163416 46509s
  1236   929  postponed  293         0.50317    0.00000   100% 165545 46937s
  1254   946  postponed  295         0.50317    0.00000   100% 167353 47425s
  1273   963  postponed  297         0.50317    0.00000   100% 169749 47915s
  1294   972  postponed  300         0.50317    0.00000   100% 171846 48408s
  1318   996  postponed  302         0.50317    0.00000   100% 173493 48943s
  1341  1009  postponed  305         0.50317    0.00000   100% 175408 49476s
  1366  1024  postponed  307         0.50317    0.00000   100% 177000 50011s
  1391  1038  postponed  310         0.50317    0.00000   100% 178534 50593s
  1422  1057  postponed  313         0.50317    0.00000   100% 179988 51173s
  1452  1072  postponed  316         0.50317    0.00000   100% 181465 51771s
  1540  1143  postponed  319         0.50317    0.00000   100% 176116 52421s
  1569  1167  postponed  322         0.50317    0.00000   100% 178652 53068s
  1690  1288  postponed  325         0.50317    0.00000   100% 170435 53699s
  1819  1419  postponed  328         0.50317    0.00000   100% 162379 54388s
  1951  1544  postponed  332         0.50317    0.00000   100% 155912 55065s
  1995  1588  postponed  335         0.50317    0.00000   100% 157057 55771s
  2078  1669  postponed  340         0.50317    0.00000   100% 155204 56546s
  2135  1717  postponed  344         0.50317    0.00000   100% 155575 57537s
  2205  1784  postponed  348         0.50317    0.00000   100% 155454 58694s
  2259  1840  postponed  352         0.50317    0.00000   100% 156500 60090s

Using improved coefficients:

Optimize a model with 8180 rows, 4710 columns and 62316 nonzeros
Model has 196 quadratic objective terms
Variable types: 2882 continuous, 1828 integer (1828 binary)
Coefficient statistics:
  Matrix range     [2e-07, 5e+02]
  Objective range  [0e+00, 0e+00]
  QObjective range [2e+00, 2e+00]
  Bounds range     [2e-03, 3e+03]
  RHS range        [1e-04, 5e+02]
Presolve removed 2468 rows and 1017 columns
Presolve time: 0.24s
Presolved: 5712 rows, 3693 columns, 58220 nonzeros
Presolved model has 196 quadratic objective terms

Loaded MIP start with objective 0.503175

Variable types: 2271 continuous, 1422 integer (1422 binary)
Presolve removed 1048 rows and 638 columns
Presolved: 4664 rows, 3465 columns, 55486 nonzeros
Presolved model has 196 quadratic objective terms


Root simplex log...

Iteration    Objective       Primal Inf.    Dual Inf.      Time
   39711    2.6740131e-02   1.123385e+01   0.000000e+00      5s
   43340    7.5293096e-13   0.000000e+00   0.000000e+00      6s
   43340    0.0000000e+00   0.000000e+00   0.000000e+00      6s

Root relaxation: objective 0.000000e+00, 43340 iterations, 5.09 seconds

    Nodes    |    Current Node    |     Objective Bounds      |     Work
 Expl Unexpl |  Obj  Depth IntInf | Incumbent    BestBd   Gap | It/Node Time

     0     0    0.00000    0  900    0.50317    0.00000   100%     -    5s
     0     0    0.00000    0  704    0.50317    0.00000   100%     -  309s
     0     0    0.00000    0  700    0.50317    0.00000   100%     -  310s
     0     0    0.00000    0  780    0.50317    0.00000   100%     -  484s
     0     0    0.00000    0  767    0.50317    0.00000   100%     -  975s
     0     0    0.00000    0  751    0.50317    0.00000   100%     - 1024s
     0     0    0.00000    0  723    0.50317    0.00000   100%     - 1195s
     0     0    0.00000    0  721    0.50317    0.00000   100%     - 1200s
     0     0    0.00000    0  722    0.50317    0.00000   100%     - 1200s
     0     2    0.00000    0  722    0.50317    0.00000   100%     - 1208s
     1     4  postponed    1         0.50317    0.00000   100% 384120 1296s
     3     4    0.00000    2  790    0.50317    0.00000   100% 148067 1395s
     7     8    0.00000    3  774    0.50317    0.00000   100% 126578 1404s
    11    11    0.00139    4  769    0.50317    0.00000   100% 84057 1407s
    23    16    0.00139    7  727    0.50317    0.00000   100% 40264 1424s
    32    25    0.11052    5  722    0.50317    0.00000   100% 30687 1513s
    34    26    0.44596    7  829    0.50317    0.00000   100% 28882 1518s
    35    27    0.44596    8  694    0.50317    0.00000   100% 28057 1809s
    36    28    0.44596    9  713    0.50317    0.00000   100% 27278 1984s
    37    28    0.44596    5  724    0.50317    0.00000   100% 26540 2353s
    38    29    0.44596    7  649    0.50317    0.00000   100% 25842 2428s
    39    30    0.41889    7  671    0.50317    0.00000   100% 25179 2607s
    40    30    0.00000    9  698    0.50317    0.00000   100% 24550 2835s
    41    31    0.44596    7  678    0.50317    0.00000   100% 23951 3084s
    42    32    0.36010    5  665    0.50317    0.00000   100% 23381 3178s
    43    32    0.44596    7  731    0.50317    0.00000   100% 22837 3380s
    44    33    0.41889    7  691    0.50317    0.00000   100% 22318 3588s
    45    34    0.44596    6  705    0.50317    0.00000   100% 21822 3679s
    46    34    0.36032    8  659    0.50317    0.00000   100% 21348 3680s
    49    36    0.11052    5  653    0.50317    0.00000   100% 20041 3695s
    51    39    0.36010    6  722    0.50317    0.00000   100% 150571 3864s
    53    40    0.36010    5  800    0.50317    0.00000   100% 144889 3869s
    54    41    0.44596    7  692    0.50317    0.00000   100% 142206 3927s
    55    42    0.44596    8  677    0.50317    0.00000   100% 139620 4019s
    56    42    0.44596    9  709    0.50317    0.00000   100% 137127 4045s
    57    43    0.44596    5  652    0.50317    0.00000   100% 134721 4059s
    58    44    0.44596    7  684    0.50317    0.00000   100% 132398 4184s
    59    44    0.41889    7  691    0.50317    0.00000   100% 130154 4505s
    60    45    0.00000    9  638    0.50317    0.00000   100% 127985 5022s
    61    46    0.44596    7  659    0.50317    0.00000   100% 125887 5289s
    62    46    0.36010    5  646    0.50317    0.00000   100% 123856 5304s
    63    47    0.44596    7  645    0.50317    0.00000   100% 121890 5444s
    64    48    0.41889    7  620    0.50317    0.00000   100% 119986 5446s
    65    48    0.44596    6  696    0.50317    0.00000   100% 118140 5534s
    66    49    0.36032    8  671    0.50317    0.00000   100% 116350 6703s
    67    50    0.23354    4  708    0.50317    0.00000   100% 114613 6866s
    68    50    0.36010    5  705    0.50317    0.00000   100% 112928 7067s
    69    51    0.11052    5  657    0.50317    0.00000   100% 111291 7590s
    70    52    0.44596    8  704    0.50317    0.00000   100% 109701 8702s
    71    52    0.36010    6  698    0.50317    0.00000   100% 108156 8951s
    74    54    0.44596    7  697    0.50317    0.00000   100% 103772 8959s
    76    56    0.44596    9  722    0.50317    0.00000   100% 306720 9368s
    78    57    0.44596    7  821    0.50317    0.00000   100% 298856 9373s
    79    58    0.41889    7  637    0.50317    0.00000   100% 295073 9912s
    80    59    0.00000    9  675    0.50317    0.00000   100% 291384 9932s
    81    59    0.44596    7  688    0.50317    0.00000   100% 287787 10041s
    82    60    0.36010    5  690    0.50317    0.00000   100% 284278 10207s
    83    61    0.44596    7  629    0.50317    0.00000   100% 280852 10845s
    84    61    0.41889    7  673    0.50317    0.00000   100% 277509 11129s
    85    62    0.44596    6  713    0.50317    0.00000   100% 274244 11214s
    86    63    0.36032    8  662    0.50317    0.00000   100% 271055 11358s
    87    63    0.23354    4  678    0.50317    0.00000   100% 267940 11373s
    88    64    0.36010    5  659    0.50317    0.00000   100% 264895 11470s
    89    65    0.11052    5  670    0.50317    0.00000   100% 261919 11715s
    92    67    0.11052    5  667    0.50317    0.00000   100% 253378 11729s
    94    69    0.44596    7  722    0.50317    0.00000   100% 325257 12265s
    96    70    0.44596    9  785    0.50317    0.00000   100% 318481 12270s
    97    71    0.44596    5  659    0.50317    0.00000   100% 315198 12502s
    98    72    0.44596    7  646    0.50317    0.00000   100% 311982 12516s
    99    72    0.41889    7  651    0.50317    0.00000   100% 308830 13538s
   100    73    0.00000    9  660    0.50317    0.00000   100% 305742 13830s
   101    74    0.44596    7  651    0.50317    0.00000   100% 302715 13868s
   102    74    0.36010    5  667    0.50317    0.00000   100% 299747 13909s
   103    75    0.44596    7  679    0.50317    0.00000   100% 296837 14045s
   104    76    0.41889    7  695    0.50317    0.00000   100% 293983 14127s
   106    77    0.36032    8  701    0.50317    0.00000   100% 288436 14314s
   107    78    0.23354    4  669    0.50317    0.00000   100% 285740 14548s
   108    78    0.36010    5  693    0.50317    0.00000   100% 283094 14623s
   109    79    0.11052    5  661    0.50317    0.00000   100% 280497 14873s
   112    81    0.11052    5  657    0.50317    0.00000   100% 272984 14886s
   114    84    0.44596    7  722    0.50317    0.00000   100% 338995 15498s
   116    85    0.44596    9  781    0.50317    0.00000   100% 333150 15504s
   117    86    0.44596    5  672    0.50317    0.00000   100% 330303 15591s
   118    87    0.44596    7  656    0.50317    0.00000   100% 327503 15785s
   119    87    0.41889    7  649    0.50317    0.00000   100% 324751 15914s
   120    88    0.00000    9  650    0.50317    0.00000   100% 322045 16092s
   121    89    0.44596    7  628    0.50317    0.00000   100% 319383 16110s
   122    89    0.36010    5  636    0.50317    0.00000   100% 316766 16315s
   123    90    0.44596    7  611    0.50317    0.00000   100% 314190 18801s
   124    91    0.41889    7  629    0.50317    0.00000   100% 311656 18825s
   125    91    0.44596    6  603    0.50317    0.00000   100% 309163 20305s
   126    92    0.36032    8  642    0.50317    0.00000   100% 306709 20732s
   127    93    0.23354    4  648    0.50317    0.00000   100% 304294 20831s
   128    93    0.36010    5  667    0.50317    0.00000   100% 301917 21180s
   129    94    0.11052    5  687    0.50317    0.00000   100% 299577 21271s
   130    95    0.44596    8  698    0.50317    0.00000   100% 297272 21291s
   131    95    0.36010    6  716    0.50317    0.00000   100% 295003 21836s
   132    96    0.11052    5  671    0.50317    0.00000   100% 292768 22010s
   133    97    0.36010    5  665    0.50317    0.00000   100% 290567 22209s
   134    97    0.44596    7  702    0.50317    0.00000   100% 288398 22299s
   135    98    0.44596    8  672    0.50317    0.00000   100% 286262 22505s
   138   100    0.44596    7  663    0.50317    0.00000   100% 280039 22513s
   140   103    0.00000    9  722    0.50317    0.00000   100% 420957 23379s
   142   104    0.36010    5  760    0.50317    0.00000   100% 415028 23385s
   143   105    0.44596    7  706    0.50317    0.00000   100% 412126 23482s
   144   106    0.41889    7  658    0.50317    0.00000   100% 409264 23529s
   145   106    0.44596    6  660    0.50317    0.00000   100% 406442 23615s
   146   107    0.36032    8  641    0.50317    0.00000   100% 403658 23657s
   147   108    0.23354    4  636    0.50317    0.00000   100% 400912 23849s
   148   108    0.36010    5  619    0.50317    0.00000   100% 398203 24253s
   149   109    0.11052    5  639    0.50317    0.00000   100% 395530 25334s
   150   110    0.44596    8  661    0.50317    0.00000   100% 392894 25470s
   151   110    0.36010    6  644    0.50317    0.00000   100% 390292 25745s
   152   111    0.11052    5  650    0.50317    0.00000   100% 387724 25893s
   153   112    0.36010    5  680    0.50317    0.00000   100% 385190 26115s
   154   112    0.44596    7  664    0.50317    0.00000   100% 382689 26346s
   155   113    0.44596    8  633    0.50317    0.00000   100% 380220 27710s
   156   114    0.44596    9  642    0.50317    0.00000   100% 377782 27832s
   157   114    0.44596    5  620    0.50317    0.00000   100% 375376 28217s
   158   115    0.44596    7  700    0.50317    0.00000   100% 373000 28313s
   159   116    0.41889    7  657    0.50317    0.00000   100% 370654 28412s
   160   116    0.00000    9  664    0.50317    0.00000   100% 368338 28552s
   161   117    0.44596    7  642    0.50317    0.00000   100% 366050 28716s
   164   119    0.41889    7  631    0.50317    0.00000   100% 359354 28727s
   166   122    0.36032    8  722    0.50317    0.00000   100% 448215 29944s
   168   123    0.36010    5  781    0.50317    0.00000   100% 442879 29949s
   169   124    0.11052    5  653    0.50317    0.00000   100% 440259 30014s
   170   125    0.44596    8  617    0.50317    0.00000   100% 437669 30028s
   171   125    0.36010    6  650    0.50317    0.00000   100% 435109 31929s
   172   126    0.11052    5  649    0.50317    0.00000   100% 432580 32152s
   173   127    0.36010    5  667    0.50317    0.00000   100% 430079 32349s
   174   127    0.44596    7  612    0.50317    0.00000   100% 427608 32461s
   175   128    0.44596    8  653    0.50317    0.00000   100% 425164 32549s
   176   129    0.44596    9  628    0.50317    0.00000   100% 422748 33316s
   177   129    0.44596    5  627    0.50317    0.00000   100% 420360 33392s
   178   130    0.44596    7  662    0.50317    0.00000   100% 417998 33538s
   179   131    0.41889    7  664    0.50317    0.00000   100% 415663 33763s
   180   131    0.00000    9  650    0.50317    0.00000   100% 413354 33785s
   181   132    0.44596    7  658    0.50317    0.00000   100% 411070 33928s
   182   133    0.36010    5  647    0.50317    0.00000   100% 408812 33946s
   183   133    0.44596    7  657    0.50317    0.00000   100% 406578 33976s
   186   135    0.36032    8  657    0.50317    0.00000   100% 400020 33988s
   188   138    0.36010    5  722    0.50317    0.00000   100% 457342 35395s
   190   139    0.44596    8  762    0.50317    0.00000   100% 452528 35401s
   191   140    0.36010    6  689    0.50317    0.00000   100% 450159 35665s
   192   141    0.11052    5  628    0.50317    0.00000   100% 447814 35921s
   193   141    0.36010    5  662    0.50317    0.00000   100% 445494 35984s
   194   142    0.44596    7  665    0.50317    0.00000   100% 443198 36136s
   195   143    0.44596    8  651    0.50317    0.00000   100% 440925 36335s
   196   143    0.44596    9  651    0.50317    0.00000   100% 438675 36547s
   197   144    0.44596    5  662    0.50317    0.00000   100% 436448 36749s
   198   145    0.44596    7  651    0.50317    0.00000   100% 434244 36867s
   199   145    0.41889    7  664    0.50317    0.00000   100% 432062 37091s
   200   146    0.00000    9  615    0.50317    0.00000   100% 429902 37511s
   201   147    0.44596    7  683    0.50317    0.00000   100% 427763 37587s
   202   147    0.36010    5  702    0.50317    0.00000   100% 425645 38755s
   203   148    0.44596    7  658    0.50317    0.00000   100% 423549 38771s
   204   149    0.41889    7  674    0.50317    0.00000   100% 421472 38988s
   205   149    0.44596    6  681    0.50317    0.00000   100% 419416 39097s
   208   151    0.36010    5  680    0.50317    0.00000   100% 413367 39108s
   210   154    0.44596    8  722    0.50317    0.00000   100% 459701 40658s
   212   155    0.11052    5  824    0.50317    0.00000   100% 455365 40742s
   213   156    0.36010    5  635    0.50317    0.00000   100% 453227 40902s
   214   157    0.44596    7  657    0.50317    0.00000   100% 451109 40962s
   215   157    0.44596    8  641    0.50317    0.00000   100% 449011 41246s
   216   158    0.44596    9  640    0.50317    0.00000   100% 446932 41341s
   217   159    0.44596    5  650    0.50317    0.00000   100% 444872 41928s
   218   159    0.44596    7  614    0.50317    0.00000   100% 442832 42070s
   219   160    0.41889    7  692    0.50317    0.00000   100% 440810 42420s
   220   161    0.00000    9  626    0.50317    0.00000   100% 438806 42650s
   221   161    0.44596    7  631    0.50317    0.00000   100% 436820 42799s
   222   162    0.36010    5  697    0.50317    0.00000   100% 434853 42915s
   223   163    0.44596    7  645    0.50317    0.00000   100% 432903 43428s
   225   164    0.44596    6  645    0.50317    0.00000   100% 429055 43435s
   227   167    0.23354    4  722    0.50317    0.00000   100% 461998 45200s
   229   168    0.11052    5  784    0.50317    0.00000   100% 457963 45206s
   230   169    0.44596    8  693    0.50317    0.00000   100% 455972 45477s
   231   170    0.36010    6  642    0.50317    0.00000   100% 453998 45652s
   232   170    0.11052    5  632    0.50317    0.00000   100% 452042 47270s
   233   171    0.36010    5  656    0.50317    0.00000   100% 450101 47287s
   234   172    0.44596    7  728    0.50317    0.00000   100% 448178 47454s
   235   172    0.44596    8  664    0.50317    0.00000   100% 446271 47578s
   236   173    0.44596    9  669    0.50317    0.00000   100% 444380 47749s
   237   174    0.44596    5  673    0.50317    0.00000   100% 442505 47775s
   238   174    0.44596    7  684    0.50317    0.00000   100% 440646 47826s
   240   176    0.00000    9  684    0.50317    0.00000   100% 436973 47845s
   241   178    0.00000  121  683    0.50317    0.00000   100% 466843 47882s
   243   180    0.00000  122  682    0.50317    0.00000   100% 463002 47970s
   246   182    0.00000  123  682    0.50317    0.00000   100% 458845 48066s
   250   182    0.00000  124  682    0.50317    0.00000   100% 454434 48163s
   254   183    0.00000  125  682    0.50317    0.00000   100% 450390 48261s
   258   185    0.00000  126  680    0.50317    0.00000   100% 445255 48383s
   262   187    0.00000  127  679    0.50317    0.00000   100% 442534 48479s
   267   186    0.00000  129  679    0.50317    0.00000   100% 438360 48572s
   272   192    0.00000  131  677    0.50317    0.00000   100% 433214 48689s
   277   194    0.00000  133  670    0.50317    0.00000   100% 429361 48815s
   281   195    0.00000  134  670    0.50317    0.00000   100% 427157 48946s
   290   199    0.00000  137  668    0.50317    0.00000   100% 415535 49054s
   298   198    0.00000  140  664    0.50317    0.00000   100% 406838 49184s
   307   206  postponed  142         0.50317    0.00000   100% 398659 49303s
   314   208    0.00000  143  651    0.50317    0.00000   100% 392104 49413s
   324   214    0.00000  147  645    0.50317    0.00000   100% 382263 49522s
   336   220    0.00000  152  637    0.50317    0.00000   100% 370792 49633s
   348   219    0.00000  156  635    0.50317    0.00000   100% 360111 49750s
   360   230    0.00000  159  633    0.50317    0.00000   100% 351160 49862s
   376   238    0.00000  164  627    0.50317    0.00000   100% 338349 49981s
   392   244    0.00000  169  634    0.50317    0.00000   100% 327509 50103s
   404   245    0.00000  170  634    0.50317    0.00000   100% 320500 50221s
   422   259    0.00000  175  622    0.50317    0.00000   100% 309227 50341s
   443   268    0.00000  180  620    0.50317    0.00000   100% 297050 50459s
   465   274    0.00000  185  607    0.50317    0.00000   100% 285361 50570s
   491   291    0.00000  192  609    0.50317    0.00000   100% 271551 50707s
   517   303    0.00000  200  605    0.50317    0.00000   100% 260731 50834s
   525   303    0.00000  203  596    0.50317    0.00000   100% 259547 50969s
   539   317    0.12487  206  586    0.50317    0.00000   100% 255526 51103s
   552   320  postponed  207         0.50317    0.00000   100% 252826 51238s
   558   323    0.00000  208  620    0.50317    0.00000   100% 252509 51434s
   581   337    0.00000  209  641    0.50317    0.00000   100% 245363 51574s
   586   334  postponed  210         0.50317    0.00000   100% 246393 51719s
   591   339    0.00000  211  616    0.50317    0.00000   100% 246312 51855s
   596   341    0.00000  212  624    0.50317    0.00000   100% 246805 52103s
   604   343    0.00000  213  605    0.50317    0.00000   100% 247378 52371s
   613   353    0.00000  214  601    0.50317    0.00000   100% 248870 52630s
   621   357    0.00000  215  612    0.50317    0.00000   100% 249993 52895s
   630   362  postponed  217         0.50317    0.00000   100% 251364 53162s
   638   367    0.00000  218  570    0.50317    0.00000   100% 252537 53424s
   646   372    0.00000  219  581    0.50317    0.00000   100% 253475 53688s
   655   379  postponed  220         0.50317    0.00000   100% 255023 53959s
   664   381    0.00000  222  603    0.50317    0.00000   100% 255601 54237s
   674   382    0.15529  224  604    0.50317    0.00000   100% 256348 54529s
   687   391    0.16973  226  610    0.50317    0.00000   100% 256056 54841s
   698   397    0.31712  228  590    0.50317    0.00000   100% 256921 55168s
   710   396  postponed  230         0.50317    0.00000   100% 257915 55553s
   724   397  postponed  231         0.50317    0.00000   100% 258595 55949s
   739   411  postponed  233         0.50317    0.00000   100% 259039 56353s
   753   408     cutoff  236         0.50317    0.00000   100% 259801 56767s
   768   413     cutoff  239         0.50317    0.00000   100% 260672 57183s
   784   424  postponed  242         0.50317    0.00000   100% 261668 57622s
   798   441  postponed  244         0.50317    0.00000   100% 263111 58031s
   811   445  postponed  245         0.50317    0.00000   100% 264379 58462s
   824   452  postponed  247         0.50317    0.00000   100% 265772 58861s
   837   469  postponed  248         0.50317    0.00000   100% 266991 59346s
   852   474  postponed  250         0.50317    0.00000   100% 268608 59883s
   868   490  postponed  252         0.50317    0.00000   100% 270192 60432s
   885   505  postponed  253         0.50317    0.00000   100% 271489 61007s
   902   514  postponed  255         0.50317    0.00000   100% 272845 61602s
   924   520  postponed  257         0.50317    0.00000   100% 272774 62243s
   947   531  postponed  259         0.50317    0.00000   100% 272927 62849s
   987   569  postponed  261         0.50317    0.00000   100% 268835 63562s
  1036   605  postponed  264         0.50317    0.00000   100% 264078 64308s
  1111   675  postponed  267         0.50317    0.00000   100% 253427 65082s


"""

### Parameters for neural net
batch = 1
in1_height = 14
in1_width = 14
stride1_height = 2
stride1_width = 2
strides1 = (1, stride1_height, stride1_width, 1)
pooled1_height = round(Int, in1_height/stride1_height, RoundUp)
pooled1_width = round(Int, in1_width/stride1_width, RoundUp)
in1_channels = 1
filter1_height = 3
filter1_width = 3
out1_channels = 4

in2_height = pooled1_height
in2_width = pooled1_width
stride2_height = 1
stride2_width = 1
strides2 = (1, stride2_height, stride2_width, 1)
pooled2_height = round(Int, in2_height/stride2_height, RoundUp)
pooled2_width = round(Int, in2_width/stride2_width, RoundUp)
in2_channels = out1_channels
filter2_height = 3
filter2_width = 3
out2_channels = 8

A_height = 64
A_width = pooled2_height*pooled2_width*out2_channels

B_height = 10
B_width = A_height

UUID = "2017-09-28_181157"
nn_params = matread("data/$UUID-ch-params.mat")
x_adv = matread("data/$UUID-adversarial-examples.mat")["adv_x"]
mnist_test_data_resized = matread("data/mnist_test_data_resized.mat")
test_index = 2 # which test sample we're choosing
y_ = mnist_test_data_resized["y_"]
x_resize = mnist_test_data_resized["x_resize"]
actual_label = get_label(y_, test_index)
x0 = get_input(x_resize, test_index) # NB: weird indexing preserves singleton first dimension

filter1 = nn_params["conv1/weight"]
bias1 = squeeze(nn_params["conv1/bias"], 1)
filter2 = nn_params["conv2/weight"]
bias2 = squeeze(nn_params["conv2/bias"], 1)
A = transpose(nn_params["fc1/weight"])
biasA = squeeze(nn_params["fc1/bias"], 1)
B = transpose(nn_params["logits/weight"])
biasB = squeeze(nn_params["logits/bias"], 1)

check_size(x0, (batch, in1_height, in1_width, in1_channels))
check_size(filter1, (filter1_height, filter1_width, in1_channels, out1_channels))
check_size(bias1, (out1_channels, ))
check_size(filter2, (filter2_height, filter2_width, in2_channels, out2_channels))
check_size(bias2, (out2_channels, ))
check_size(A, (A_height, A_width))
check_size(biasA, (A_height, ))
check_size(B, (B_height, B_width))
check_size(biasB, (B_height, ))

function calculate_predicted_label{T<:Real}(
    x0_::AbstractArray{T, 4})::Int
    x1_ = NNOps.convlayer(x0_, filter1, bias1, strides1)
    x2_ = NNOps.convlayer(x1_, filter2, bias2, strides2)
    x3_ = NNOps.flatten(x2_)
    x4_ = NNOps.fullyconnectedlayer(x3_, A, biasA)
    predicted_label = NNOps.softmaxindex(x4_, B, biasB)
    return predicted_label
end

num_samples = 100
num_correct = 0

target_label = -1 # TODO: fix
min_dist = Inf
target_sample_index = -1 # TODO: fix

test_predicted_label = calculate_predicted_label(x0)
adversarial_image = NNOps.avgpool(get_input(x_adv, test_index), (1, 2, 2, 1))
adversarial_predicted_label = calculate_predicted_label(adversarial_image)
println("FGSM adversarial image predicted label by NN is $adversarial_predicted_label, original image predicted label by NN is $test_predicted_label.")
for i = 1:num_samples
    sample_image = get_input(x_resize, i)
    sample_predicted_label = calculate_predicted_label(sample_image)
    sample_actual_label = get_label(y_, i)
    # println("Running test case $i. Predicted is $pred, actual is $actual.")
    if sample_predicted_label == sample_actual_label
        num_correct += 1
    end
    sample_dist = sum((sample_image-x0).^2)
    if (sample_predicted_label != test_predicted_label) && (sample_dist < min_dist)
        target_label = sample_predicted_label
        min_dist = sample_dist
        target_sample_index = i
        println("New minimum distance, $min_dist at target sample index $target_sample_index.")
    end
end
candidate_adversarial_example = get_input(x_resize, target_sample_index)

adversarial_dist = sum((adversarial_image-x0).^2)
if (adversarial_predicted_label!=test_predicted_label) && (adversarial_dist < min_dist)
    target_label = adversarial_predicted_label
    min_dist = adversarial_dist
    candidate_adversarial_example = adversarial_image
    println("Using adversarial example at new minimum distance, $adversarial_dist.")
end
println("Number correct on regular samples is $num_correct out of $num_samples.")

NNExamples.solve_conv_conv_fc_softmax(x0, filter1, bias1, strides1, filter2, bias2, strides2, A, biasA, B, biasB, target_label, 0.0, candidate_adversarial_example - x0)
